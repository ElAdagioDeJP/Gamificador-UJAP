<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>ER Chen – StudyBooster UJAP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Cytoscape + dagre + svg (CDN) -->
  <script src="https://unpkg.com/cytoscape@3.27.0/dist/cytoscape.min.js"></script>
  <script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
  <script src="https://unpkg.com/cytoscape-dagre@2.5.0/cytoscape-dagre.js"></script>
  <script src="https://unpkg.com/cytoscape-svg@3.0.0/cytoscape-svg.js"></script>
  <style>
    /* Light, high-contrast theme for better PDF/print legibility */
    html, body { height: 100%; margin: 0; background:#ffffff; color:#1f2a44; font-family: system-ui, Segoe UI, Roboto, Arial; }
    #cy { position: absolute; inset: 48px 0 0 0; }
    .toolbar {
      position: fixed; left: 10px; top: 8px; display: flex; gap: 8px; z-index: 10;
      background:#f2f5fb; border:1px solid #c8d1e6; padding:6px 8px; border-radius:8px;
    }
    .toolbar button {
      background:#e8eefc; color:#1f2a44; border:1px solid #b5c4ea; border-radius:6px;
      padding:6px 10px; cursor:pointer; font-size:12px;
    }
    .toolbar button:hover { background:#d7e6ff; }
    .legend { position: fixed; right: 10px; top: 8px; background: #ffffff; border: 1px solid #c8d1e6; padding: 8px 10px; border-radius: 8px; font-size: 12px; z-index: 10; }
    .legend div { margin: 4px 0; display: flex; align-items: center; gap: 6px; }
    .box { width: 14px; height: 14px; display:inline-block; border:2px solid; }
    .round { border-radius: 6px; }
    .ell { border-radius: 50%; }
    .dia { transform: rotate(45deg); width: 12px; height: 12px; }
  /* Legend swatches */
  .swatch.entity { border-color:#1f5fbf; background:#eef5ff; }
  .swatch.relation { border-color:#c77c00; background:#fff7e6; }
  .swatch.attribute { border-color:#6b7b8c; background:#f3f6f9; }
  .swatch.group { border-color:#9aa6b2; background:#f5f7fb; }
  </style>
</head>
<body>
  <div class="toolbar">
    <button id="relayout">Auto organizar</button>
    <button id="fit">Ajustar</button>
    <button id="exportSvg">Exportar SVG</button>
  </div>
  <div id="cy"></div>
  <div class="legend">
  <div><span class="box round swatch entity"></span> Entidad</div>
  <div><span class="box dia swatch relation"></span> Relación (Chen)</div>
  <div><span class="box ell swatch attribute"></span> Atributo</div>
  <div><span class="box round swatch group"></span> Grupo (dominio)</div>
    <div>Cardinalidad en arista: 1, N, 0..1, 1..N</div>
    <div>PK marcada como (PK)</div>
  </div>

  <script>
    cytoscape.use(cytoscapeDagre);
    // Registrar plugin de exportación a SVG (maneja UMD y default)
    (function registerSvgPlugin(){
      try {
        const w = window;
        const plugin = (w && (w.cytoscapeSvg || (w.cytoscapeSvg && w.cytoscapeSvg.default))) || (typeof cytoscapeSvg !== 'undefined' && (cytoscapeSvg.default || cytoscapeSvg));
        if (plugin) cytoscape.use(plugin);
      } catch(e) { console.warn('No se pudo registrar cytoscape-svg:', e); }
    })();

    // Helpers
    const Group = (id, label) => ({ data: { id, label, type:'group' }});
    const E = (id, label, parent) => ({ data: { id, label, type:'entity', parent }});
    const R = (id, label, parent) => ({ data: { id, label, type:'relation', parent }});
    const A = (id, label, parent) => ({ data: { id, label, type:'attribute', parent }});
    const ER = (src, rel, trg, cardSrc) => ({ data: { id:`${src}_${rel}_${trg}`, source: src, target: rel, label: cardSrc||'' }});
    const RE = (rel, trg, card) => ({ data: { id:`${rel}_${trg}`, source: rel, target: trg, label: card||'' }});
    const EA = (ent, attr) => ({ data: { id:`${ent}_${attr}`, source: ent, target: attr }});

    // Grupos (dominios) para una disposición más clara
    const G_USR  = 'G_Usuarios';
    const G_ACAD = 'G_Academico';
    const G_MIS  = 'G_Misiones';
    const G_DUE  = 'G_Duelos';
    const G_REW  = 'G_Recompensas';
    const G_QR   = 'G_QR';
    const G_TASK = 'G_Tareas';

    const groups = [
      Group(G_USR,  'Usuarios'),
      Group(G_ACAD, 'Académico'),
      Group(G_MIS,  'Misiones / Insignias'),
      Group(G_DUE,  'Duelos'),
      Group(G_REW,  'Recompensas / Canjes'),
      Group(G_QR,   'Códigos QR'),
      Group(G_TASK, 'Tareas Personales'),
    ];

    // Entities
    const entities = [
      E('Usuarios','Usuarios', G_USR),
      E('Materias','Materias', G_ACAD),
      E('Inscripciones','Inscripciones (M:N)', G_ACAD),
      E('Profesor_Materias','Profesor_Materias (M:N)', G_ACAD),

      E('Misiones','Misiones', G_MIS),
      E('Usuario_Misiones','Usuario_Misiones', G_MIS),
      E('Insignias','Insignias', G_MIS),
      E('Usuario_Insignias','Usuario_Insignias', G_MIS),

      E('Duelos','Duelos', G_DUE),
      E('Duelo_Participantes','Duelo_Participantes', G_DUE),
      E('Preguntas_Duelo','Preguntas_Duelo', G_DUE),
      E('Respuestas_Duelo','Respuestas_Duelo', G_DUE),

      E('Recompensas_Canjeables','Recompensas_Canjeables', G_REW),
      E('Usuario_Canjes','Usuario_Canjes', G_REW),

      E('Codigos_QR','Codigos_QR', G_QR),
      E('Usuario_Escaneos_QR','Usuario_Escaneos_QR', G_QR),

      E('Tareas_Personales','Tareas_Personales', G_TASK),
    ];

    // Relations
    const rels = [
      R('Rel_Inscribe','Inscribe', G_ACAD),
      R('Rel_Ensenia','Enseña', G_ACAD),
      R('Rel_Pertenece','Pertenece', G_MIS),
      R('Rel_Crea','Crea', G_MIS),
      R('Rel_TieneMision','Tiene', G_MIS),
      R('Rel_Desbloquea','Desbloquea', G_MIS),
      R('Rel_Otorga','Otorga', G_MIS),

      R('Rel_Participa','ParticipaEn', G_DUE),
      R('Rel_UsaMateria','UsaMateria', G_DUE),
      R('Rel_Compuesta','CompuestaPor', G_DUE),

      R('Rel_Canjea','Canjea', G_REW),

      R('Rel_Escanea','Escanea', G_QR),

      R('Rel_Planifica','Planifica', G_TASK),
    ];

    // Attributes (solo principales para no saturar)
    const attrs = [
      // Usuarios
      A('A_id_usuario','id_usuario (PK)', G_USR),
      A('A_nombre_usuario','nombre_usuario', G_USR),
      A('A_email','email_institucional', G_USR),
      A('A_rol','rol', G_USR),
      A('A_puntos','puntos_actuales', G_USR),

      // Materias
      A('A_id_materia','id_materia (PK)', G_ACAD),
      A('A_nombre_materia','nombre_materia', G_ACAD),

      // Misiones
      A('A_id_mision','id_mision (PK)', G_MIS),
      A('A_tipo_mision','tipo_mision', G_MIS),
      A('A_dificultad','dificultad', G_MIS),
      A('A_puntos_recompensa','puntos_recompensa', G_MIS),

      // Usuario_Misiones
      A('A_estado_um','estado', G_MIS),
      A('A_fecha_comp','fecha_completada', G_MIS),

      // Duelos
      A('A_id_duelo','id_duelo (PK)', G_DUE),
      A('A_estado_duelo','estado', G_DUE),

      // Preguntas/Respuestas
      A('A_id_preg','id_pregunta (PK)', G_DUE),
      A('A_id_resp','id_respuesta (PK)', G_DUE),

      // Recompensas y Canjes
      A('A_id_recomp','id_recompensa (PK)', G_REW),
      A('A_costo','costo_en_puntos', G_REW),
      A('A_aprob_doc','requiere_aprobacion_docente', G_REW),

      // QR
      A('A_id_qr','id_qr (PK)', G_QR),
      A('A_fecha_escaneo','fecha_escaneo', G_QR),

      // Tareas personales
      A('A_id_tarea','id_tarea (PK)', G_TASK),
      A('A_estado_tarea','estado', G_TASK)
    ];

    // Edges con cardinalidades
    const edges = [
      // Inscribe: Usuarios — Inscripciones — Materias
      ER('Usuarios','Rel_Inscribe','Usuarios','(Est.)'), RE('Rel_Inscribe','Inscripciones',''),
      RE('Rel_Inscribe','Materias',''),
      { data:{ id:'card_insc_u', source:'Usuarios', target:'Rel_Inscribe', label:'1..N (est.)' }},
      { data:{ id:'card_insc_m', source:'Materias', target:'Rel_Inscribe', label:'1..N' }},

      // Enseña: Usuarios (profesor) — Profesor_Materias — Materias
      ER('Usuarios','Rel_Ensenia','Usuarios','(Prof.)'), RE('Rel_Ensenia','Profesor_Materias',''),
      RE('Rel_Ensenia','Materias',''),
      { data:{ id:'card_ens_u', source:'Usuarios', target:'Rel_Ensenia', label:'1..N (prof.)' }},
      { data:{ id:'card_ens_m', source:'Materias', target:'Rel_Ensenia', label:'1..N' }},

      // Pertenece: Misiones -> Materias (0..1)
      ER('Misiones','Rel_Pertenece','Misiones',''), RE('Rel_Pertenece','Materias','0..1'),
      { data:{ id:'card_per_mis', source:'Misiones', target:'Rel_Pertenece', label:'N' }},

      // Crea: Usuarios (prof) -> Misiones
      ER('Usuarios','Rel_Crea','Usuarios','(Prof.)'), RE('Rel_Crea','Misiones','N'),
      { data:{ id:'card_crea_u', source:'Usuarios', target:'Rel_Crea', label:'1..N (prof.)' }},

      // Tiene: Usuarios — Usuario_Misiones — Misiones
      ER('Usuarios','Rel_TieneMision','Usuarios'), RE('Rel_TieneMision','Usuario_Misiones',''),
      RE('Rel_TieneMision','Misiones',''),
      { data:{ id:'card_um_u', source:'Usuarios', target:'Rel_TieneMision', label:'1..N' }},
      { data:{ id:'card_um_m', source:'Misiones', target:'Rel_TieneMision', label:'1..N' }},

      // Desbloquea: Misiones — Insignias
      ER('Misiones','Rel_Desbloquea','Misiones'), RE('Rel_Desbloquea','Insignias','0..N'),
      { data:{ id:'card_desb_m', source:'Misiones', target:'Rel_Desbloquea', label:'0..1' }},

      // Otorga: Usuarios — Usuario_Insignias — Insignias
      ER('Usuarios','Rel_Otorga','Usuarios'), RE('Rel_Otorga','Usuario_Insignias',''),
      RE('Rel_Otorga','Insignias',''),
      { data:{ id:'card_ui_u', source:'Usuarios', target:'Rel_Otorga', label:'1..N' }},
      { data:{ id:'card_ui_i', source:'Insignias', target:'Rel_Otorga', label:'1..N' }},

      // Participa: Usuarios — Duelo_Participantes — Duelos
      ER('Usuarios','Rel_Participa','Usuarios'), RE('Rel_Participa','Duelo_Participantes',''),
      RE('Rel_Participa','Duelos',''),
      { data:{ id:'card_dp_u', source:'Usuarios', target:'Rel_Participa', label:'1..N' }},
      { data:{ id:'card_dp_d', source:'Duelos', target:'Rel_Participa', label:'1..N' }},

      // UsaMateria: Duelos — Materias (1)
      ER('Duelos','Rel_UsaMateria','Duelos'), RE('Rel_UsaMateria','Materias','1'),
      { data:{ id:'card_du_m', source:'Duelos', target:'Rel_UsaMateria', label:'N' }},

      // CompuestaPor: Preguntas_Duelo — Respuestas_Duelo (1:N)
      ER('Preguntas_Duelo','Rel_Compuesta','Preguntas_Duelo'), RE('Rel_Compuesta','Respuestas_Duelo','N'),
      { data:{ id:'card_pr_r', source:'Preguntas_Duelo', target:'Rel_Compuesta', label:'1' }},

      // Canjea: Usuarios — Usuario_Canjes — Recompensas_Canjeables
      ER('Usuarios','Rel_Canjea','Usuarios'), RE('Rel_Canjea','Usuario_Canjes',''),
      RE('Rel_Canjea','Recompensas_Canjeables',''),
      { data:{ id:'card_uc_u', source:'Usuarios', target:'Rel_Canjea', label:'1..N' }},
      { data:{ id:'card_uc_r', source:'Recompensas_Canjeables', target:'Rel_Canjea', label:'1..N' }},

      // Escanea: Usuarios — Usuario_Escaneos_QR — Codigos_QR
      ER('Usuarios','Rel_Escanea','Usuarios'), RE('Rel_Escanea','Usuario_Escaneos_QR',''),
      RE('Rel_Escanea','Codigos_QR',''),
      { data:{ id:'card_qr_u', source:'Usuarios', target:'Rel_Escanea', label:'1..N' }},
      { data:{ id:'card_qr_q', source:'Codigos_QR', target:'Rel_Escanea', label:'1..N' }},

      // Planifica: Usuarios — Tareas_Personales (1:N)
      ER('Usuarios','Rel_Planifica','Usuarios'), RE('Rel_Planifica','Tareas_Personales','N'),
      { data:{ id:'card_tp_u', source:'Usuarios', target:'Rel_Planifica', label:'1' }},
    ];

    // Attribute links (muestra solo claves y campos clave para claridad)
    const attrEdges = [
      EA('Usuarios','A_id_usuario'), EA('Usuarios','A_nombre_usuario'),
      EA('Usuarios','A_email'), EA('Usuarios','A_rol'), EA('Usuarios','A_puntos'),

      EA('Materias','A_id_materia'), EA('Materias','A_nombre_materia'),

      EA('Misiones','A_id_mision'), EA('Misiones','A_tipo_mision'),
      EA('Misiones','A_dificultad'), EA('Misiones','A_puntos_recompensa'),

      EA('Usuario_Misiones','A_estado_um'), EA('Usuario_Misiones','A_fecha_comp'),

      EA('Duelos','A_id_duelo'), EA('Duelos','A_estado_duelo'),
      EA('Preguntas_Duelo','A_id_preg'), EA('Respuestas_Duelo','A_id_resp'),

      EA('Recompensas_Canjeables','A_id_recomp'), EA('Recompensas_Canjeables','A_costo'),
      EA('Recompensas_Canjeables','A_aprob_doc'),

      EA('Codigos_QR','A_id_qr'), EA('Usuario_Escaneos_QR','A_fecha_escaneo'),

      EA('Tareas_Personales','A_id_tarea'), EA('Tareas_Personales','A_estado_tarea'),
    ];

    const cy = cytoscape({
      container: document.getElementById('cy'),
      elements: {
        nodes: [ ...groups, ...entities, ...rels, ...attrs ],
        edges: [ ...edges, ...attrEdges ]
      },
      style: [
        // Grupos
    { selector: 'node[type="group"]',
          style: {
      'label': 'data(label)',
      'text-valign': 'top', 'text-halign': 'left',
      'text-margin-x': 8, 'text-margin-y': 8,
      'font-size': 14, 'font-weight': 600, 'color': '#1f2a44',
      'background-color': '#f5f7fb', 'background-opacity': 0.35,
      'border-color': '#9aa6b2', 'border-width': 2, 'border-style': 'dashed',
      'padding': '18px', 'shape': 'round-rectangle'
        }},
        // Entidades
        { selector: 'node[type="entity"]',
          style: {
      'label': 'data(label)', 'text-wrap': 'wrap', 'text-max-width': 140,
      'font-size': 12, 'text-valign': 'center', 'text-halign': 'center',
      'color': '#1f2a44', 'background-color': '#ffffff',
      'border-color': '#1f5fbf', 'border-width': 2,
      'shape': 'round-rectangle', 'padding': '8px'
        }},
        // Relaciones
        { selector: 'node[type="relation"]',
          style: {
      'shape': 'diamond', 'background-color': '#fff7e6',
      'border-color': '#c77c00', 'border-width': 2, 'padding': '10px',
      'label': 'data(label)', 'font-size': 12, 'color': '#7a4b00'
        }},
        // Atributos
        { selector: 'node[type="attribute"]',
          style: {
      'shape': 'ellipse', 'background-color': '#f3f6f9',
      'border-color': '#6b7b8c', 'border-width': 2, 'padding': '6px',
      'label': 'data(label)', 'font-size': 11, 'color': '#2b3a4a'
        }},
        // Aristas
        { selector: 'edge',
          style: {
      'width': 2,
      'line-color': '#495057',
            'curve-style': 'straight',
            'target-arrow-shape': 'none',
            'label': 'data(label)',
            'font-size': 10,
            'min-zoomed-font-size': 6,
      'text-background-color': '#ffffff',
      'text-background-opacity': 0.85,
            'text-background-shape': 'round-rectangle',
            'text-border-opacity': 0,
      'color': '#1f2a44',
            'text-rotation': 'autorotate',
            'text-margin-y': -6
        }}
      ],
      layout: {
        name: 'dagre',
        rankDir: 'LR',
        nodeSep: 28,
        rankSep: 140,
        edgeSep: 22,
        align: 'UL'
      },
      autoungrabify: true,
      wheelSensitivity: 0.15
    });

    // Ejecuta un layout interno para los hijos de un grupo (mejora la legibilidad dentro de cada dominio)
    function layoutGroupChildren(groupId, opts) {
      const group = cy.getElementById(groupId);
      const kids = group.children();
      if (!kids || kids.length === 0) return;
      kids.layout({ name: 'dagre', nodeSep: 22, rankSep: 60, edgeSep: 10, ...(opts || {}) }).run();
    }

    function runLayout() {
      // 1) Layout interno por grupo (reduce cruces dentro de cada dominio)
      layoutGroupChildren(G_USR,  { rankDir: 'TB' });
      layoutGroupChildren(G_ACAD, { rankDir: 'TB' });
      layoutGroupChildren(G_MIS,  { rankDir: 'LR' });
      layoutGroupChildren(G_DUE,  { rankDir: 'LR' });
      layoutGroupChildren(G_REW,  { rankDir: 'TB' });
      layoutGroupChildren(G_QR,   { rankDir: 'TB' });
      layoutGroupChildren(G_TASK, { rankDir: 'TB' });

      // 2) Distribuir grupos en una grilla lógica (preset)
      const W = cy.width(), H = cy.height();
      const grid = [
        { id: G_USR,  x: 0.10 * W, y: 0.50 * H },
        { id: G_ACAD, x: 0.30 * W, y: 0.50 * H },
        { id: G_MIS,  x: 0.52 * W, y: 0.28 * H },
        { id: G_DUE,  x: 0.52 * W, y: 0.72 * H },
        { id: G_REW,  x: 0.74 * W, y: 0.25 * H },
        { id: G_QR,   x: 0.74 * W, y: 0.52 * H },
        { id: G_TASK, x: 0.74 * W, y: 0.80 * H },
      ];

      grid.forEach(cell => {
        const g = cy.getElementById(cell.id);
        if (!g || g.length === 0) return;
        const bb = g.boundingBox({ includeChildren: true });
        const cx = bb.x1 + bb.w / 2;
        const cyy = bb.y1 + bb.h / 2;
        const dx = cell.x - cx;
        const dy = cell.y - cyy;
        g.children().shift({ x: dx, y: dy });
      });

      // 3) Layout global muy suave para ajustar aristas externas (no mueve mucho los nodos)
      cy.elements().layout({ name: 'dagre', rankDir: 'LR', nodeSep: 28, rankSep: 140, edgeSep: 18, align: 'UL' }).run();
    }

    runLayout();
    cy.fit();

  // Acciones UI
    document.getElementById('relayout').onclick = () => { runLayout(); cy.fit(); };
    document.getElementById('fit').onclick = () => cy.fit();

    // Exportar a SVG
    document.getElementById('exportSvg').onclick = () => {
      // Preferir SVG; si no está el plugin, exportar PNG como respaldo
      if (typeof cy.svg === 'function') {
        // Guardar estilo original
        const originalStyle = cy.style().json();
        // Forzar texto blanco con contorno oscuro para que sea legible en PDF/fondo claro
        cy.style()
          .selector('node, edge')
          .style({
            'color': '#ffffff',
            'text-background-opacity': 0,
            'text-outline-color': '#1f2a44',
            'text-outline-width': 2
          })
          .update();

        // Esperar al siguiente frame para asegurar aplicación de estilo antes de exportar
        requestAnimationFrame(() => {
          let svgContent = cy.svg({ scale: 1, full: true });
          // Inyectar estilo dentro del SVG para forzar texto blanco (text y tspan)
          const injectStyle = '\\n<style><![CDATA[ text, tspan { fill: #ffffff !important; stroke: #1f2a44; stroke-width: 1.6px; paint-order: stroke fill; stroke-linejoin: round; font-weight: 600; font-family: system-ui, \\"Segoe UI\\", Roboto, Arial, sans-serif; } ]]></style>\\n';
          svgContent = svgContent.replace(/<svg([^>]*)>/, '<svg$1>' + injectStyle);
          // Restaurar estilo original
          cy.style().fromJson(originalStyle).update();

          const blob = new Blob([svgContent], { type: 'image/svg+xml;charset=utf-8' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'ER-Chen-Gamificador-UJAP.svg';
          a.click();
          URL.revokeObjectURL(url);
        });
      } else {
        // Aplicar temporalmente texto blanco también para PNG
        const originalStyle = cy.style().json();
        cy.style()
          .selector('node, edge')
          .style({
            'color': '#ffffff',
            'text-background-opacity': 0,
            'text-outline-color': '#1f2a44',
            'text-outline-width': 2
          }).update();

        const pngDataUrl = cy.png({ full: true, scale: 2, background: '#ffffff' });
        // Restaurar estilo
        cy.style().fromJson(originalStyle).update();

        const a = document.createElement('a');
        a.href = pngDataUrl;
        a.download = 'ER-Chen-Gamificador-UJAP.png';
        a.click();
        alert('El plugin SVG no está disponible. Se exportó PNG con texto blanco como alternativa.');
      }
    };

    // Ajuste al redimensionar
    window.addEventListener('resize', () => { cy.resize(); cy.fit(); });
  </script>
</body>
</html>